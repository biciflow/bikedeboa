<!doctype html>

<html lang="pt-br">
    <head>
        <meta charset="UTF-8">
        <title>admin</title>

        <!-- CSS -->
        <link rel="stylesheet" type="text/css" href="/css/vendors.min.css"/>
        <!-- <link rel="stylesheet" type="text/css" href="/css/main.css"/> -->

        <!-- Google Fonts (async) -->
        <link async href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
        <link async href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

        <!-- Google Maps API -->
        <!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD6TeLzQCvWopEQ7hBdbktYsmYI9aNjFc8&libraries=places&language=pt-BR" type="text/javascript"></script> -->

        <!-- JS -->
       <!-- CSS (async) -->
        <link async rel="stylesheet" type="text/css" href="/css/vendors.min.css"/>
        <link async rel="stylesheet" type="text/css" href="/css/main.min.css"/> 

        <!-- JS --> 
        <script src="/js/lib/jquery.js"></script> 
        <script src="/js/lib/bootstrap.js"></script>
        <script src="/js/lib/handlebars.js"></script>
        <script src="/js/lib/js.cookie.js"></script>
        <script src="/js/lib/native.history.js"></script>
        <script src="/js/lib/sweetalert2.js"></script>
        <script src="/js/lib/toastr.js"></script> 
        <script src="/js/lib/velocity.js"></script> 
        <script src="/js/lib/velocity.ui.js"></script>
        <script src="/js/app.min.js"></script>

        <!-- Bootstrap Extended Tables -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.js"></script>

        <!-- Extensions -->
        <!-- editable -->
        <script src="https://rawgit.com/vitalets/x-editable/master/dist/bootstrap3-editable/js/bootstrap-editable.js"></script>
        <link rel="stylesheet" href="https://rawgit.com/vitalets/x-editable/master/dist/bootstrap3-editable/css/bootstrap-editable.css">
        <script src="/lib/bootstrap-table-extensions/editable/bootstrap-table-editable.js"></script>
        <!-- mobile -->
        <script src="/lib/bootstrap-table-extensions/mobile/bootstrap-table-mobile.js"></script>
        <!-- sticky-header -->
        <script src="/lib/bootstrap-table-extensions/sticky-header/bootstrap-table-sticky-header.js"></script>
        <link rel="stylesheet" href="/lib/bootstrap-table-extensions/sticky-header/bootstrap-table-sticky-header.css">
        <!-- export -->
        <script src="/lib/bootstrap-table-extensions/export/bootstrap-table-export.js"></script>
        <script src="//rawgit.com/hhurz/tableExport.jquery.plugin/master/tableExport.js"></script>

        <!-- Font Awesome -->
        <script src="https://use.fontawesome.com/9c52cfba3f.js"></script>

        <style>
          body {
            font-family: "Roboto", Arial, sans-serif;
            /*margin-top: 100px;*/
            padding: 2%;
            overflow: auto;
          }

          tbody > tr:not(.detail-view) {
            cursor: pointer;
          }

          tbody > tr:hover:not(.detail-view) {
            background-color: #f5f5f5;
          }

          th, .col-title {
            font-family: 'Raleway', sans-serif;
          }

          td,
          td a.editable-pre-wrapped {
            max-width: 100px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
          }

          td.col-fulltext {
            white-space: normal;
          }

          .editable-empty {
            color: #E9BB2B;
          }

          th {
            text-align: center;
          }

          .col-reviews {
            max-width: 70px;
          }

          .col-title {
            max-width: 150px;
          }
          td.col-title {
            font-size: 1.2em;
            font-weight: 600;
          }

          .col-timestamp {
            max-width: 150px;
          }

          td.col-timestamp,
          td.col-description,
          td.col-full-text,
          td.col-address {
            font-size: 0.8em;
          }

          .col-id {
            width: 60px;
            color: gray;
          }

          .details-view img {
            float: right;
            max-height: 600px;
          }


          .dashboard-panel {
            max-height: 70vh;
            overflow-y: auto;
            /*overflow-x: hidden; */
          }

          #logged {
            display: none;
          }

          section {
            padding: 50px;
            margin: 70px 0 0;
            background-color: rgba(0,0,0,0.02);
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
          }

          section + section {
            margin: 30px 0;
          }

          .navbar-default {
            background-color: #30bb6a;
          }

          .nav-pills > li {
            font-size: 1.8em;
          }

          .tab-content h2 {
            font-size: 20px;
          }

          .restricted-access {
            display: none;
          }

        </style>
    </head>

    <body>
      <div id="loginWrapper" style="float: right;">
        <button id="login" type="button" class="btn btn-lg btn-default" >
          <span class="glyphicon glyphicon-user"></span> Login
        </button>

        <div id="logged" class="btn-group">
          <button class="btn btn-default btn-lg btn-success dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <span class="glyphicon glyphicon-user"></span> <span id="loggedUser"></span> <span class="caret"></span>
          </button>
          <ul class="dropdown-menu">
            <li><a id="logOff" href="#">Log off</a></li>
          </ul>
        </div>
      </div>

      <!-- <nav class="navbar navbar-default navbar-fixed-top">
        <ul class="nav navbar-nav navbar-right">
          <li>
          </li>
        </ul>
      </nav> -->

      <section class="restricted-access">
          <h2>
            <i class="fa fa-lightbulb-o"></i>
            <span id="headingRevisions">Carregando sugestões...</span>
          </h2>

          <table
            id="revisionsTable"
            data-classes="table table-no-bordered"
            data-search="true"
            data-show-toggle="true"
            data-show-columns="true"
            data-show-footer="false"
            data-sticky-header="true">
          </table>
      </section>

      <section>
        <ul class="nav nav-tabs nav-pills nav-justified" role="tablist">
          <li role="presentation" class="active">
            <a href="#bicicletarios" aria-controls="bicicletarios" role="tab" data-toggle="tab">
              <i class="fa fa-bicycle"></i>
              Bicicletarios
            </a>
          </li>
          <li role="presentation" class="restricted-access">
            <a href="#usuarios" aria-controls="usuarios" role="tab" data-toggle="tab">
              <i class="fa fa-users"></i>
              Usuarios
            </a>
          </li>
          <li role="presentation" class="restricted-access">
            <a href="#log" aria-controls="log" role="tab" data-toggle="tab">
              <i class="fa fa-list"></i>
              Log
            </a>
          </li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content">
          <div role="tabpanel" class="tab-pane fade in active" id="bicicletarios">

            <!-- Tabela de Bicicletarios -->

            <h2>
              <span id="headingBikes"></span>
            </h2>

            <table
              id="localsTable"
              data-classes="table table-no-bordered"
              data-striped="true"
              data-search="true"
              data-show-refresh="true"
              data-show-toggle="true"
              data-show-columns="true"
              data-show-export="true"
              data-detail-view="true"
              data-detail-formatter="detailFormatter"
              data-row-style="rowStyle"
              data-show-footer="false"
              data-sticky-header="true">
            </table>

          </div>


          <!-- Tabela de Usuarios -->

          <div role="tabpanel" class="tab-pane fade" id="usuarios" class="restricted-access">
            <h2>
              <span id="headingUsers">Carregando usuários...</span>
            </h2>

            <table
              id="usersTable"
              data-classes="table table-no-bordered"
              data-search="true"
              data-show-toggle="true"
              data-show-columns="true"
              data-show-footer="false"
              data-sticky-header="true">
            </table>
          </div>


          <!-- Tabela de Log -->

          <div role="tabpanel" class="tab-pane fade" id="log" class="restricted-access">
            <h2 id="headingLog">
              Carregando log... (pode demorar pq é um monte de log e essa lib de datatable é uma bosta)
            </h2>

            <!-- <div id="logTable"></div> -->

            <table
              id="logTable"
              data-classes="table table-no-bordered"
              data-search="true"
              data-show-toggle="true"
              data-show-columns="true"
              data-show-footer="false"
              data-detail-view="true"
              data-detail-formatter="detailFormatter"
              data-sticky-header="true">
            </table>
          </div>
        </div>
      </section>

      <script>
        // Generic function to display in textual form all the properties of a table entry
        function detailFormatter(index, row) {
          var html = '';

          html += '<div class="details-view">';

          if (row.photo) {
            html += `<img src='${row.photo}'></img>`;
          }

          if (row.lat && row.lng) {
            html += '<iframe width="500" height="250" style="float: right;" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://maps.google.com/maps?q='+row.lat+','+row.lng+'&hl=es;z=14&amp;output=embed"></iframe>';
          }

          $.each(row, function (key, value) {
            switch (key) {
              case 'updatedAt':
              case 'createdAt':
                html += '<span><b>' + key + ':</b> ' + timestampColFormatter(value) + '</span><br>';
                break;
              case 'body':
                html += '<span><b>' + key + ':</b> ' + jsonColFormatter(value) + '</span><br>';
                break;
              case 'photo':
                break;
              default:
                html += '<span><b>' + key + ':</b> ' + value + '</span><br>';
                break;
            }
          });

          html += '</div>';

          return html;
        }

        function rowStyle(row, index) {
          // const classes = ['active', 'success', 'info', 'warning', 'danger'];
          if (row.text && row.text.length > 0 &&
              row.structureType != null &&
              row.isPublic != null) {
            return {
              // classes: 'success'
            };
          } else {
            return {
              // classes: 'warning'
            };
          }
        }

        // function photoColFormatter(value) {
        //   return value ? 'Sim' : '-';
        // }

        function timestampColFormatter(value) {
          return value && new Date(value).toLocaleString('pt-BR');
        }

        function endpointNameColFormatter(value) {
          let ret = value;
          if (value) {
            if (value.indexOf('bdb-api') > 0) {
              ret = ret.slice(28);
            } else if (value.indexOf('localhost') > 0) {
              ret = ret.slice(21);
            }
          }

          return ret;
        }

        function jsonColFormatter(value) {
          return value && JSON.stringify(value);
        }

        function updateLocalsTable(force = false) {
          if (force) {
            markers = null;
          }

          if (markers) {
            return;
          }

          $('#headingBikes').html('Carregando bicicletários...');
            
          Database.getPlaces( () => {
            $('#headingBikes').html(`<span class="text-muted">(${markers.length} carregados)</span>`);

            let structureTypes = [];
            for(let i=0; i < STRUCTURE_NAMES.length; i++) {
              structureTypes.push({value: STRUCTURE_CODES[i], text: STRUCTURE_NAMES[i]});
            }

            // Massage data for BootstrapTable
            markers.forEach( m => {
              if (m.isPublic === true) {
                m.isPublic = 1;
              } else if (m.isPublic === false) {
                m.isPublic = 0;
              }
            });

            $('#localsTable').bootstrapTable({
              columns: [
                { 
                  field: 'updatedAt', title: 'Modificado em', sortable: true, class: 'col-timestamp', formatter: 'timestampColFormatter', visible: false,
                },
                {
                  field: 'createdAt', title: 'Criado em', sortable: true, class: 'col-timestamp', formatter: 'timestampColFormatter'
                },
                {
                  field: 'id', title: 'ID', sortable: true, class: 'col-id',
                },
                {
                  field: 'text', title: 'Titulo', sortable: true, class: 'col-title',
                    editable: loggedUser && true
                },
                {
                  field: 'address', title: 'Endereço', sortable: true, class: 'col-address',
                    editable: loggedUser && true, 'editable-type': 'textarea'
                },
                {
                  field: 'lat', title: 'lat', sortable: true, visible: false,
                },
                {
                  field: 'lng', title: 'lng', sortable: true, visible: false,
                },
                {
                  field: 'isPublic', title: 'Público?', sortable: true,
                    editable: loggedUser && true, 'editable-type': 'select', 'editable-source': "[{'value': '1', 'text': 'Publico'}, {'value': '0', 'text': 'Exclusivo'} ]"
                },
                {
                  field: 'structureType', title: 'Tipo', sortable: true,
                    editable: loggedUser && true, 'editable-type': 'select', 'editable-source': JSON.stringify(structureTypes).replace(/\"/g, '\'')
                },
                {
                  field: 'average', title: 'Média', sortable: true, visible: true,
                },
                {
                  field: 'reviews', title: 'Avaliações', sortable: true, class: 'col-reviews'
                },
                {
                  field: 'checkins', title: 'Check-ins',sortable: true, visible: false,
                },
                {
                  field: 'description', title: 'Descrição', sortable: true, class: 'col-description',
                    editable: loggedUser && true, 'editable-type': 'textarea'
                },
                {
                  field: 'photo', title: 'Foto', sortable: true,
                    editable: loggedUser && true 
                },
                {
                  field: 'operate', title: '', align: 'center', events: localsTableOperateEvents, formatter: operateFormatter, visible: loggedUser
                }
              ],
              data: markers,
              sortName: 'updatedAt', sortOrder: 'desc'
            });
          }, null, null, true);
        }

        function updateUsersTable() {
          if (users) {
            return;
          }

          BIKE.Database.customAPICall('get','user', null, data => {
            users = data;

            $('#headingUsers').html(`<span class="text-muted">(${data.length} carregados)</span>`);

            $('#usersTable').bootstrapTable({
              columns: [
                {
                  field: 'id', title: 'ID', sortable: true, class: 'col-id', visible: false,
                },
                {
                  field: 'username', title: 'Usuário', sortable: true, class: 'col-title',
                },
                {
                  field: 'fullname', title: 'Nome completo', sortable: true, editable: loggedUser && true
                },
                {
                  field: 'role', title: 'Cargo', sortable: true, editable: loggedUser && true, 'editable-type': 'select', 'editable-source': "[{'value': 'admin', 'text': 'Admin'}, {'value': 'colaborator', 'text': 'Colaborador'}, {'value': 'client', 'text': 'Cliente'} ]"
                },
                {
                  field: 'updatedAt', title: 'Modificado em', sortable: true, class: 'col-timestamp', formatter: 'timestampColFormatter'
                },
                {
                  field: 'createdAt', title: 'Criado em', sortable: true, class: 'col-timestamp', formatter: 'timestampColFormatter'
                },
              ],
              data: users,
              sortName: 'id', sortOrder: 'desc'
            });
          });
        }

        function updateRevisionTable(force = false) {
          if (force) {
            revisions = null;
          }
          
          if (revisions) {
            return;
          }

          BIKE.Database.customAPICall('get','revision', null, data => {
            revisions = data;

            $('#headingRevisions').html(`Sugestões de Correção <span class="text-muted">(${data.length})</span>`);

            $('#revisionsTable').bootstrapTable({
              columns: [
                {
                  field: 'updatedAt', title: 'Modificado em', sortable: true, class: 'col-timestamp', formatter: 'timestampColFormatter', visible: false
                },
                {
                  field: 'createdAt', title: 'Criado em', sortable: true, class: 'col-timestamp', formatter: 'timestampColFormatter'
                },
                {
                  field: 'local_id', title: 'ID Bicicletário', sortable: true
                },
                {
                  field: 'Local.text', title: 'Bicicletário', sortable: true, class: 'col-title',
                },
                {
                  field: 'id', title: 'ID', sortable: true, class: 'col-id', visible: false,
                },
                {
                  field: 'comments', title: 'Mensagem', sortable: true, class: 'col-fulltext',
                },
                {
                  field: 'operate', title: '', align: 'center', events: logTableOperateEvents, formatter: operateFormatter
                }
              ],
              data: revisions,
              sortName: 'id', sortOrder: 'desc'
            });
          });
        }

        window.logTableOperateEvents = {
          'click .remove': function (e, value, row, index) {
            if (confirm('Tem certeza?')) {
              BIKE.Database.customAPICall('delete', `revision/${row.id}`, null, () => {
                updateRevisionTable(true);
              });
            }
          }
        };

        window.localsTableOperateEvents = {
          'click .remove': function (e, value, row, index) {
            if (confirm('Tem certeza?')) {
              BIKE.Database.customAPICall('delete', `local/${row.id}`, null, () => {
                updateLocalsTable(true);
              });
            }
          }
        };

        function operateFormatter(value, row, index) {
          return [
            '<a class="remove" href="javascript:void(0)" title="Deletar">',
            '<i class="glyphicon glyphicon-trash"></i>',
            '</a>'
          ].join('');
        }

        function updateLogTable() {
          if (log) {
            return;
          }

          BIKE.Database.customAPICall('get','log', null, data => {
            log = data;

            $('#headingLog').html(`<span class="text-muted">(${data.length} carregados)</span>`);

            // let html = '<table style="width: 100%;">';
            // html += '<thead>';
            // html += '<tr>';
            // html += '<th>updatedAt</th>';
            // html += '<th>createdAt</th>';
            // html += '<th>user</th>';
            // html += '<th>ip_origin</th>';
            // html += '<th>role</th>';
            // html += '<th>endpoint</th>';
            // html += '<th>id</th>';
            // html += '<th>body</th>';
            // html += '</tr>';
            // html += '</thead><tbody>';
            // log.forEach( i => {
            //   html += '<tr>';
            //   html += `<td>${timestampColFormatter(i.updatedAt)}</td>`;
            //   html += `<td>${timestampColFormatter(i.createdAt)}</td>`;
            //   html += `<td>${i.user}</td>`;
            //   html += `<td>${i.ip_origin}</td>`;
            //   html += `<td>${i.role}</td>`;
            //   html += `<td>${endpointNameColFormatter(i.endpoint)}</td>`;
            //   html += `<td>${i.id}</td>`;
            //   html += `<td>${jsonColFormatter(i.body)}</td>`;
            //   html += '</tr>';
            // });
            // html += '</tbody></table>';
            // $('#logTable').html(html);

            $('#logTable').bootstrapTable({
              columns: [
                {
                  field: 'updatedAt', title: 'updatedAt', sortable: true, formatter: 'timestampColFormatter', visible: false,
                },
                {
                  field: 'createdAt', title: 'createdAt', sortable: true, formatter: 'timestampColFormatter'
                },
                {
                  field: 'user', title: 'user', sortable: true
                },
                {
                  field: 'ip_origin', title: 'IP', sortable: true
                },
                {
                  field: 'role', title: 'role', sortable: true, visible: false,
                },
                {
                  field: 'endpoint', title: 'endpoint', sortable: true, formatter: 'endpointNameColFormatter'
                },
                {
                  field: 'method', title: 'method', sortable: true
                },
                {
                  field: 'id', title: 'id', sortable: true, visible: false,
                },
                {
                  field: 'body', title: 'body', sortable: true, formatter: 'jsonColFormatter'
                },
              ],
              data: log,
              sortName: 'createdAt', sortOrder: 'desc'
            });
          }, true);
        }

        function handleLoggedUser() {
          if (loggedUser) {
            $('#login').hide();
            $('#logged').show();
            $('#loggedUser').html(loggedUser);
            $('.restricted-access').show();
          }
        }

        function login() {
          Database.authenticate(true, () => {
            if (loggedUser) {
              window.location.reload();
            }
          });
        }

        function logOff() {
          Cookies.remove('bikedeboa_user');
          window.location.reload();
        }

        function init() {
          showSpinner();

          Database.authenticate(false, () => {
            if (loggedUser) {
              handleLoggedUser();

              Database.getAllTags();

              updateRevisionTable();

              updateLocalsTable();
            } else {
              $('.restricted-access').remove();

              login();
            }

            hideSpinner();
          });
        }


        /////////////////////
        // Initializations //
        /////////////////////

        Database = BIKE.Database;

        // Admin-only Globals
        let users;
        let log;
        let revisions;
        let ga = function() {};


        $.fn.editable.defaults.toggle = 'dblclick';


        init();

        //
        // Triggers
        //

        $('a[data-toggle="tab"]').on('shown.bs.tab', e => {
          const tabName = e.target.getAttribute('aria-controls');
          switch (tabName) {
          case 'log':
            updateLogTable();
            break;
          case 'usuarios':
            updateUsersTable();
            break;
          }
        });

        $('#login').on('click', e => {
          login();
        });

        $('body').on('click', '#logOff', e => {
          logOff();
        });


        $('body').on('click', 'tbody tr td', e => {
          if (e.target == e.currentTarget) {
            console.log('details');
            $(e.currentTarget).siblings().find('.detail-icon').trigger('click');
          }
        });

        function updateUser(field, row, oldValue, $el) {
          const userId = row.id;
          let dataToUpdate = {};
          dataToUpdate[field] = row[field];

          // Send the updated data through the API
          if (dataToUpdate) {
            console.log('updating:', dataToUpdate);
            BIKE.Database.customAPICall('put', `user/${userId}`, dataToUpdate);
          }
        }

        function updateLocal(field, row, oldValue, $el) {
          const localId = row.id;
          let dataToUpdate = {};

          if (field === 'isPublic') {
            row[field] = row[field]==='1' ? true : false;
          } else if (field === 'photo') {
            row['photoUrl'] = row[field];
            field = 'photoUrl';
          }

          dataToUpdate[field] = row[field];

          // Send the updated data through the API
          if (dataToUpdate) {
            console.log('updating:', dataToUpdate);
            BIKE.Database.customAPICall('put', `local/${localId}`, dataToUpdate);
          }
        }

        $('body').on('editable-save.bs.table', (e, field, row, oldValue, $el) => {
          if (row.username) {
            updateUser(field, row, oldValue, $el);
          } else {
            updateLocal(field, row, oldValue, $el);
          }

        });


      </script>

    </body>

</html>
