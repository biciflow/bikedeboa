<!doctype html>

<html lang="pt-br">
    <head>
        <meta charset="UTF-8">
        <title>bike de boa | dados</title>
        <meta property="og:title" content="bike de boa | dados" />

        <!-- Favicons -->
        <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png?v=m2dAvrr4RB">
        <link rel="icon" type="image/png" href="/favicons/favicon-32x32.png?v=m2dAvrr4RB" sizes="32x32">
        <link rel="icon" type="image/png" href="/favicons/favicon-16x16.png?v=m2dAvrr4RB" sizes="16x16">

        <!-- Google Maps API -->
        <!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD6TeLzQCvWopEQ7hBdbktYsmYI9aNjFc8&libraries=places&language=pt-BR" type="text/javascript"></script> -->

        <!-- Google Analytics --> 
        <script>
          if ('BDB_ENV' === 'prod') {
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-19085664-3', {'siteSpeedSampleRate': 100});
            ga('require', 'GTM-MCCV34X');
            ga('send', 'pageview');
          } else {
            ga = function() {};            
          }
        </script>

        <script>
          WebFontConfig = {
            google: {
              families: ['Quicksand:500,500i,700']
              // families: ['Ubuntu:400,400i,700']
              // families: ['Poppins:400,400i,700']
            }
          };

          (function (d) {
            var wf = d.createElement('script'), s = d.scripts[0];
            wf.src = 'https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js';
            wf.async = true;
            s.parentNode.insertBefore(wf, s);
          })(document);
        </script> 

        <!-- CSS (async) -->
        <link async rel="stylesheet" type="text/css" href="/css/vendors.min.css"/>
        <link async rel="stylesheet" type="text/css" href="/css/main.min.css"/> 

        <!-- JS --> 
        <script src="/js/lib/jquery.js"></script> 
        <script src="/js/lib/bootstrap.js"></script>
        <script src="/js/lib/handlebars.js"></script>
        <script src="/js/lib/js.cookie.js"></script>
        <script src="/js/lib/native.history.js"></script>
        <script src="/js/lib/sweetalert2.js"></script>
        <script src="/js/lib/hello.all.js"></script>
        <script src="/js/lib/toastr.js"></script> 
        <script src="/js/lib/velocity.js"></script> 
        <script src="/js/lib/velocity.ui.js"></script>
        <script src="/js/lib/hello.all.js"></script>
        <script src="/lib/featherlight.min.js"></script>
        <script src="/js/app.min.js"></script>

        <!-- Bootstrap Extended Tables -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.js"></script>

        <!-- Extensions -->
        <!-- editable -->
        <script src="https://rawgit.com/vitalets/x-editable/master/dist/bootstrap3-editable/js/bootstrap-editable.js"></script>
        <link rel="stylesheet" href="https://rawgit.com/vitalets/x-editable/master/dist/bootstrap3-editable/css/bootstrap-editable.css">
        <script src="/lib/bootstrap-table-extensions/editable/bootstrap-table-editable.js"></script>
        <!-- mobile -->
        <script src="/lib/bootstrap-table-extensions/mobile/bootstrap-table-mobile.js"></script>
        <!-- sticky-header -->
        <script src="/lib/bootstrap-table-extensions/sticky-header/bootstrap-table-sticky-header.js"></script>
        <link rel="stylesheet" href="/lib/bootstrap-table-extensions/sticky-header/bootstrap-table-sticky-header.css">
        <!-- export -->
        <script src="/lib/bootstrap-table-extensions/export/bootstrap-table-export.js"></script>
        <script src="//rawgit.com/hhurz/tableExport.jquery.plugin/master/tableExport.js"></script>

        <!-- Font Awesome -->
        <script src="https://use.fontawesome.com/9c52cfba3f.js"></script>

        <style>
          body::-webkit-scrollbar {
              display: initial;
          }

          body {
            font-family: "Roboto", Arial, sans-serif;
            padding: 24px;
            overflow: auto;
            padding-top: 60px;
            background: white;
          }

          h2 {
            font-size: 16px;
            width: 60%;
            color: #828b90;
          }

          #logo {
            left: 24px;
          }

          #userBtn {
            right: 24px;
          }

          tbody > tr:not(.detail-view) {
            cursor: pointer;
          }

          tbody > tr:hover:not(.detail-view) {
            background-color: #f5f5f5;
          }

          td,
          td a.editable-pre-wrapped {
            max-width: 100px;
            overflow: hidden;
            /*white-space: nowrap;*/
            /*text-overflow: ellipsis;*/
          }

          td.col-fulltext {
            white-space: normal;
          }

          .editable-empty {
            color: #E9BB2B;
          }

          th {
            text-align: center;
          }

          .col-reviews {
            max-width: 70px;
          }

          .col-title {
            max-width: 150px;
          }
          td.col-title {
            font-size: 1.2em;
            font-weight: 600;
          }

          .col-timestamp {
            max-width: 150px;
          }

          td.col-timestamp,
          td.col-description,
          td.col-full-text,
          td.col-address {
            font-size: 0.8em;
          }

          .col-id {
            width: 60px;
            color: gray;
          }

          .details-view img {
            float: right;
            max-height: 600px;
          }

          a {
            background: none;
            box-shadow: none;
            border-bottom: none;
          }

          .dashboard-panel {
            max-height: 70vh;
            overflow-y: auto;
            /*overflow-x: hidden; */
          }

          #logged {
            display: none;
          }

          section {
            margin: 60px 0 0;
            /*padding: 50px;*/
            /*background-color: rgba(0,0,0,0.02);*/
            /*box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);*/
          }

          section + section {
            margin: 30px 0;
          }

          .topbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            background: white;
            z-index: 3;
            height: 70px;
          }

          .nav {
            position: sticky;
            top: 60px;
            z-index: 2;
            background: white;
            margin: 0 -24px;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            padding: 12px 24px;
          }

          .navbar-default {
            background-color: #30bb6a;
          }

          .nav-pills > li {
            /*font-size: 1.8em;*/
            text-transform: uppercase;
            font-weight: bold;
          }

          .nav-pills>li.active>a, .nav-pills>li.active>a:focus, .nav-pills>li.active>a:hover {
            background: #30bb6a;
          }

          .tab-content h2 {
            font-size: 20px;
          }

          .restricted-access {
            display: none !important;
          }

          #userBtn {
            display: block !important;
          }

        </style>
    </head>

    <body>
      <div class="topbar">
        <h1 id="logo">
          <a href="/" class="unstyled-link">bike de boa</a> 
        </h1>

        <div id="userBtn" class="dropdown">
          <button class="" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <img class="avatar" src="/img/icon_user_big.svg">
          </button>

          <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu1">
            <li>
              <button class="loginBtn"><img src="/img/icon_login.svg"> Login</button>
            </li>
            
            <li>
              <button class="logoutBtn"><img src="/img/icon_logout.svg"> Logout</button>
            </li>
          </ul>
        </div>
      </div>

      <h2>
        <p>
          Assim como nosso código fonte, os dados do bike de boa também são abertos!
        </p>
        
        <p>
          Estes são nossos dados brutos em forma de tabela. Explore, filtre, e faça download em vários formatos como Excel, CSV, XML e JSON.
        </p>

        <div class="social-links-list" style="margin-top: 2em;">
          <a class="facebook-social-link social-link unstyled-link" target="_blank" rel="noopener" href="https://www.facebook.com/bikedeboaapp">
            <img alt="" src="/img/icon_social_facebook.svg"/>
          </a>
          <a class="instagram-social-link social-link unstyled-link" target="_blank" rel="noopener" href="https://www.instagram.com/bikedeboa/">
            <img alt="" src="/img/icon_social_instagram.svg"/>
          </a>
          <a class="medium-social-link social-link unstyled-link" target="_blank" rel="noopener" href="https://medium.com/bike-de-boa/">
            <img alt="" src="/img/icon_social_medium.svg"/>
          </a>
          <a class="github-social-link social-link unstyled-link" target="_blank" rel="noopener" href="https://github.com/cmdalbem/bikedeboa">
            <img alt="" src="/img/icon_social_github.svg"/>
          </a>
        </div>
      </h2>

      <section>
        <ul class="nav nav-pills" role="tablist">
          <li role="presentation">
            <a href="#locals" aria-controls="locals" role="tab" data-toggle="tab">
              <!-- <i class="fa fa-bicycle"></i> -->
              Bicicletários
            </a>
          </li>
          <li role="presentation" class="restricted-access">
            <a href="#reviews" aria-controls="reviews" role="tab" data-toggle="tab">
              <!-- <i class="fa fa-users"></i> -->
              Avaliações
            </a>
          </li>
          <li role="presentation" class="restricted-access">
            <a href="#users" aria-controls="users" role="tab" data-toggle="tab">
              <!-- <i class="fa fa-users"></i> -->
              Usuários
            </a>
          </li>
          <li role="presentation" class="restricted-access">
            <a href="#revisions" aria-controls="revisions" role="tab" data-toggle="tab">
              <!-- <i class="fa fa-comments"></i> -->
              Sugestões de correção
            </a>
          </li>
          <li role="presentation" class="restricted-access">
            <a href="#logs" aria-controls="logs" role="tab" data-toggle="tab">
              <!-- <i class="fa fa-list"></i> -->
              Log
            </a>
          </li>
          <li role="presentation" class="restricted-access" class="active">
            <a href="#importador" aria-controls="importador" role="tab" data-toggle="tab">
              <!-- <i class="fa fa-list"></i> -->
              Importador de KML
            </a>
          </li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content">
          <div role="tabpanel" class="tab-pane fade" id="locals">

            <!-- Tabela de Bicicletarios -->

            <h2>
              Carregando...
            </h2>

            <table
              id="localsTable"
              data-classes="table table-no-bordered"
              data-striped="true"
              data-search="true"
              data-show-toggle="true"
              data-show-columns="true"
              data-show-export="true"
              data-detail-view="true"
              data-detail-formatter="genericDetailsFormatter"
              data-row-style="rowStyle"
              data-show-footer="false"
              data-pagination="true"
              data-paginationVAlign="both"
              data-show-pagination-switch="true"
              data-sidePagination="client"
              data-showPaginationSwitch="true"
              data-sticky-header="false">
            </table>

          </div>


          <!-- Tabela de Sugestoes das pessoas -->

          <div role="tabpanel" class="tab-pane fade" id="revisions" class="restricted-access">
            <h2>
              Carregando...
            </h2>

            <table
              id="revisionsTable"
              data-classes="table table-no-bordered"
              data-search="true"
              data-show-toggle="true"
              data-show-columns="true"
              data-show-footer="false"
              data-detail-view="true"
              data-detail-formatter="genericDetailsFormatter"
              data-sticky-header="false">
            </table>
          </div>


          <!-- Tabela de Usuarios -->

          <div role="tabpanel" class="tab-pane fade" id="users" class="restricted-access">
            <h2>
              Carregando...
            </h2>

            <table
              id="usersTable"
              data-classes="table table-no-bordered"
              data-search="true"
              data-show-toggle="true"
              data-show-columns="true"
              data-show-footer="false"
              data-detail-view="true"
              data-detail-formatter="genericDetailsFormatter"
              data-sticky-header="false">
            </table>
          </div>


          <!-- Tabela de Avaliações -->

          <div role="tabpanel" class="tab-pane fade" id="reviews" class="restricted-access">
            <h2>
              Carregando...
            </h2>

            <table
              id="reviewsTable"
              data-classes="table table-no-bordered"
              data-search="true"
              data-show-toggle="true"
              data-show-columns="true"
              data-show-footer="false"
              data-show-export="true"
              data-detail-view="true"
              data-detail-formatter="genericDetailsFormatter"
              data-pagination="true"
              data-paginationVAlign="both"
              data-show-pagination-switch="true"
              data-sidePagination="client"
              data-showPaginationSwitch="true"
              data-sticky-header="false">
            </table>
          </div>


          <!-- Tabela de Log -->

          <div role="tabpanel" class="tab-pane fade" id="logs" class="restricted-access">
            <h2>
              Carregando...
            </h2>

            <!-- <div id="logTable"></div> -->

            <table
              id="logTable"
              data-classes="table table-no-bordered"
              data-search="true"
              data-show-toggle="true"
              data-show-columns="true"
              data-show-footer="false"
              data-show-export="true"
              data-detail-view="true"
              data-detail-formatter="genericDetailsFormatter"
              data-pagination="true"
              data-paginationVAlign="both"
              data-show-pagination-switch="true"
              data-sidePagination="client"
              data-showPaginationSwitch="true"
              data-sticky-header="false">
            </table>
          </div>
          
          
          <!-- Importador de dados -->

          <div role="tabpanel" class="tab-pane fade in active" id="importador" class="restricted-access">
            <p>
              <input id="kmlFileInput" type="file" name="kmlFileInput" accept="*" />
            </p>
            
            <table id="importTable"
              data-classes="table table-no-bordered"
              data-search="true"
              data-show-toggle="true"
              data-show-columns="true" 
              data-show-footer="false"
              data-detail-view="true"
              data-detail-formatter="genericDetailsFormatter"
              data-sticky-header="false">
            </table>
          </div>
        </div>
      </section>

      <script>

        
        // Generic function to display in textual form all the properties of a table entry
        function genericDetailsFormatter(index, row) {
          let html = '';

          html += '<div class="details-view">';

          if (row.photo) {
            html += `<img src='${row.photo}'></img>`;
          }

          if (row.lat && row.lng) {
            html += '<iframe width="500" height="250" style="float: right;" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://maps.google.com/maps?q='+row.lat+','+row.lng+'&hl=es;z=14&amp;output=embed"></iframe>';
          }

          $.each(row, function (key, value) {
            switch (key) {
            case 'updatedAt':
            case 'createdAt':
              html += '<span><b>' + key + ':</b> ' + timestampColFormatter(value) + '</span><br>';
              break;
            case 'body':
              html += '<span><b>' + key + ':</b> ' + jsonColFormatter(value) + '</span><br>';
              break;
            case 'photo':
              break;
            case 'User':
              if (value) {
                html += '<span><b>' + key + ':</b> ' + value.fullname + '</span><br>';
              }
              break; 
            case 'Locals':
              html += '<div><b>' + key + ':</b></div>';
              html += '<ul>';
              value.forEach( l => {
                html += `<li>name=${l.text}</li>`;
              });
              html += '</ul>';
              break;
            case 'Reviews':
              // html += '<span><b>' + key + ':</b> ' + value.map(t => t.name).join('・') + '</span><br>';
              html += '<div><b>' + key + ':</b></div>';
              
              // Counts total of tags, and at the same time prints each reviews contents into a <ul>
              html += '<ul>';
              let tags = {};
              value.forEach( r => {
                html += `<li>local id=${r.local_id}, rating=${r.rating}, user id=${r.user_id}</li>`;
                if (r.Tags) {
                  r.Tags.forEach( t => {
                    tags[t.name] = (tags[t.name] || 0) + 1;
                  });
                }
              });
              html += '</ul>';
              
              // Prints each tags count
              html += '<div><b>Tags:</b></div>';
              html += '<ul>';
              Object.keys(tags).forEach( k => {
                html += `<li><b>${k}:</b> ${tags[k]}</li>`;
              })
              html += '</ul>';
              break;
            case '_hasDetails':
              break;
            default:
              html += '<span><b>' + key + ':</b> ' + value + '</span><br>';
              break;
            }
          });

          html += '</div>';

          return html;
        }

        function rowStyle(row, index) {
          // const classes = ['active', 'success', 'info', 'warning', 'danger'];
          if (row.text && row.text.length > 0 &&
              row.structureType != null &&
              row.isPublic != null) {
            return {
              // classes: 'success'
            };
          } else {
            return {
              // classes: 'warning'
            };
          }
        }


        ///////////////////////
        // Column Formatters //
        ///////////////////////

        function tagsListColFormatter(tags) {
          const ret = tags.map(tag => tag.name).join('・');
          return ret;
        }

        function photoColFormatter(value) { 
          const ret = '<img src="' + value + '" style="width: 50px; height: 50px;"/>';
          return ret;
        }

        function timestampColFormatter(value) {
          return value && new Date(value).toLocaleString('pt-BR');
        }
        
        function booleanColFormatter(value) {
          if (value === 0) {
            return 'não';
          } else if (value === 1) {
            return 'sim';
          } else {
            return '-';
          }
        }

        function endpointNameColFormatter(value) {
          let ret = value;
          if (value) {
            if (value.indexOf('bdb-api') > 0) {
              ret = ret.slice(28);
            } else if (value.indexOf('localhost') > 0) {
              ret = ret.slice(21);
            }
          }

          return ret;
        }

        function jsonColFormatter(value) {
          return value && JSON.stringify(value);
        }

        function updateLocalsTable(force = false) {
          if (force) {
            markers = null;
          }

          // if (markers) {
          //   return;
          // }

          $('#locals h2').html('Carregando...');

          $('#locals').addClass('loading');
            
          Database.getPlaces( () => {
            $('#locals').removeClass('loading');

            $('#locals h2').html(`<span class="text-muted">${markers.length} resultados</span>`);
            // $('[aria-controls="locals"]').append(`<span class="text-muted"> (${markers.length})</span>`);

            let structureTypes = [];
            for(let i=0; i < STRUCTURE_NAMES.length; i++) {
              structureTypes.push({value: STRUCTURE_CODES[i], text: STRUCTURE_NAMES[i]});
            }

            // Massage data for BootstrapTable
            markers.forEach( m => {
              if (m.isPublic === true) {
                m.isPublic = 1;
              } else if (m.isPublic === false) {
                m.isPublic = 0;
              }

              if (m.isCovered === true) {
                m.isCovered = 1;
              } else if (m.isCovered === false) {
                m.isCovered = 0;
              }
            });

            $('#locals table').bootstrapTable({
              columns: [
                {
                  field: 'id', title: 'ID', sortable: true, class: 'col-id', visible: !!BDB.User.isAdmin
                },
                { 
                  field: 'updatedAt', title: 'Modificado em', sortable: true, class: 'col-timestamp', formatter: 'timestampColFormatter', visible: false
                },
                {
                  field: 'createdAt', title: 'Criado em', sortable: true, class: 'col-timestamp', formatter: 'timestampColFormatter'
                },
                {
                  field: 'text', title: 'Nome', sortable: true, class: 'col-title', editable: !!BDB.User.isAdmin
                },
                {
                  field: 'address', title: 'Endereço', sortable: true, class: 'col-address', editable: !!BDB.User.isAdmin, 'editable-type': 'textarea'
                },
                {
                  field: 'lat', title: 'lat', sortable: true, visible: false,
                },
                {
                  field: 'lng', title: 'lng', sortable: true, visible: false,
                },
                {
                  field: 'isPublic', title: 'Público?', sortable: true, editable: !!BDB.User.isAdmin, 'editable-type': 'select', 'editable-source': "[{'value': '1', 'text': 'Publico'}, {'value': '0', 'text': 'Exclusivo'} ]",
                },
                {
                  field: 'isCovered', title: 'Coberto?', sortable: true, editable: !!BDB.User.isAdmin, 'editable-type': 'select', 'editable-source': "[{'value': '1', 'text': 'Coberto'}, {'value': '0', 'text': 'Não coberto'} ]",
                },
                {
                  field: 'structureType', title: 'Tipo', sortable: true, editable: !!BDB.User.isAdmin, 'editable-type': 'select', 'editable-source': JSON.stringify(structureTypes).replace(/\"/g, '\'')
                },
                {
                  field: 'reviews', title: 'Avaliações', sortable: true, class: 'col-reviews'
                },
                {
                  field: 'average', title: 'Média', sortable: true, visible: true,
                },
                {
                  field: 'views', title: 'Visualizações', sortable: true, visible: true,
                },
                {
                  field: 'description', title: 'Descrição', sortable: true, class: 'col-description', editable: !!BDB.User.isAdmin, 'editable-type': 'textarea', visible: false
                },
                {
                  field: 'photo', title: 'Foto', sortable: true, editable: !!BDB.User.isAdmin, visible: !!BDB.User.isAdmin
                },
                {
                  field: 'operate', title: '', align: 'center', events: localsTableOperateEvents, formatter: operateFormatter, visible: !!BDB.User.isAdmin
                }
              ],
              data: markers,
              sortName: 'id', sortOrder: 'desc'
            });
          }, null, null, true);
        }

        function updateUsersTable() {
          if (users) {
            return;
          }

          $('#users').addClass('loading');

          BDB.Database.customAPICall('get','user').then(data => {
            $('#users').removeClass('loading');

            users = data;

            $('#users h2').html(`<span class="text-muted">${data.length} resultados</span>`);
            // $('[aria-controls="users"]').append(`<span class="text-muted"> (${data.length})</span>`);

            $('#users table').bootstrapTable({
              columns: [
                {
                  field: 'id', title: 'ID', sortable: true, class: 'col-id',
                },
                {
                  field: 'username', title: 'Usuário', sortable: true, class: 'col-title', visible: false
                },
                {
                  field: 'fullname', title: 'Nome completo', sortable: true, editable: !!BDB.User.isAdmin
                },
                {
                  field: 'role', title: 'Cargo', sortable: true, editable: !!BDB.User.isAdmin
                },
                {
                  field: 'email', title: 'Email', sortable: true, editable: !!BDB.User.isAdmin
                },
                {
                  field: 'Reviews.length', title: 'Avaliações', sortable: true
                },
                {
                  field: 'Locals.length', title: 'Bicicletários', sortable: true,
                },
                {
                  field: 'facebook_id', title: 'ID Facebook', sortable: true, editable: !!BDB.User.isAdmin, visible: false
                },
                {
                  field: 'google_id', title: 'ID Google', sortable: true, editable: !!BDB.User.isAdmin, visible: false
                },
                {
                  field: 'updatedAt', title: 'Modificado em', sortable: true, class: 'col-timestamp', formatter: 'timestampColFormatter', visible: false
                },
                {
                  field: 'createdAt', title: 'Criado em', sortable: true, class: 'col-timestamp', formatter: 'timestampColFormatter'
                },
              ],
              data: users,
              sortName: 'id', sortOrder: 'desc'
            });
          });
        }

        function updateReviewsTable() {
          if (reviews) {
            return;
          }

          $('#reviews').addClass('loading');

          BDB.Database.customAPICall('get','review').then( data => {
            $('#reviews').removeClass('loading');

            reviews = data;

            $('#reviews h2').html(`<span class="text-muted">${data.length} resultados</span>`);
            // $('[aria-controls="reviews"]').append(`<span class="text-muted"> (${data.length})</span>`);
            
            $('#reviews table').bootstrapTable({
              columns: [
                {
                  field: 'id', title: 'ID', sortable: true, class: 'col-id', visible: false
                },
                {
                  field: 'createdAt', title: 'Criado em', sortable: true, class: 'col-timestamp', formatter: 'timestampColFormatter'
                },
                {
                  field: 'Local.text', title: 'Bicicletário', sortable: true, class: 'col-title',
                },
                {
                  field: 'User.fullname', title: 'Usuário', sortable: true,
                },
                {
                  field: 'rating', title: 'Nota', sortable: true, editable: !!BDB.User.isAdmin
                },
                {
                  field: 'Tags', title: 'Tags', sortable: true, formatter: 'tagsListColFormatter', class: 'col-address'
                },
                {
                  field: 'updatedAt', title: 'Modificado em', sortable: true, class: 'col-timestamp', formatter: 'timestampColFormatter', visible: false
                },
              ],
              data: reviews,
              sortName: 'createdAt', sortOrder: 'desc'
            });
          });
        }

        function updateRevisionTable(force = false) {
          if (force) {
            revisions = null;
          }
          
          if (revisions) {
            return;
          }

          $('#revisions').addClass('loading');

          BDB.Database.customAPICall('get','revision').then(data => {
            $('#revisions').removeClass('loading');

            revisions = data;

            $('#revisions h2').html(`<span class="text-muted">${data.length} resultados</span>`);
            // $('[aria-controls="revisions"]').append(`<span class="text-muted"> (${data.length})</span>`);

            $('#revisions table').bootstrapTable({
              columns: [
                {
                  field: 'updatedAt', title: 'Modificado em', sortable: true, class: 'col-timestamp', formatter: 'timestampColFormatter', visible: false
                },
                {
                  field: 'createdAt', title: 'Criado em', sortable: true, class: 'col-timestamp', formatter: 'timestampColFormatter'
                },
                {
                  field: 'Local.text', title: 'Bicicletário', sortable: true, class: 'col-title',
                },
                {
                  field: 'local_id', title: 'ID Bicicletário', sortable: true, visible: false,
                },
                {
                  field: 'id', title: 'ID', sortable: true, class: 'col-id', visible: false,
                },
                {
                  field: 'comments', title: 'Mensagem', sortable: true, class: 'col-fulltext',
                },
                {
                  field: 'operate', title: '', align: 'center', events: logTableOperateEvents, formatter: operateFormatter
                }
              ],
              data: revisions,
              sortName: 'id', sortOrder: 'desc'
            });
          });
        }

        window.logTableOperateEvents = {
          'click .remove': function (e, value, row, index) {
            if (confirm('Tem certeza?')) {
              BDB.Database.customAPICall('delete', `revision/${row.id}`, null, () => {
                updateRevisionTable(true);
              });
            }
          }
        };

        window.localsTableOperateEvents = {
          'click .remove': function (e, value, row, index) {
            if (confirm('Tem certeza?')) {
              BDB.Database.customAPICall('delete', `local/${row.id}`, null, () => {
                updateLocalsTable(true);
              });
            }
          }
        };

        function operateFormatter(value, row, index) {
          return [
            '<a class="remove" href="javascript:void(0)" title="Deletar">',
            '<i class="glyphicon glyphicon-trash"></i>',
            '</a>'
          ].join('');
        }

        function updateLogTable() {
          if (log) {
            return;
          }

          BDB.Database.customAPICall('get','log').then(data => {
            log = data;

            $('#logs h2').html(`<span class="text-muted">${data.length} resultados</span>`);
            // $('[aria-controls="logs"]').append(`<span class="text-muted"> (${data.length})</span>`);

            $('#logs table').bootstrapTable({
              columns: [
                {
                  field: 'updatedAt', title: 'updatedAt', sortable: true, formatter: 'timestampColFormatter', visible: false,
                },
                {
                  field: 'createdAt', title: 'createdAt', sortable: true, formatter: 'timestampColFormatter'
                },
                {
                  field: 'user', title: 'user', sortable: true
                },
                {
                  field: 'ip_origin', title: 'IP', sortable: true, visible: false
                },
                {
                  field: 'role', title: 'role', sortable: true, visible: false,
                },
                {
                  field: 'endpoint', title: 'endpoint', sortable: true, formatter: 'endpointNameColFormatter'
                },
                {
                  field: 'method', title: 'method', sortable: true
                },
                {
                  field: 'id', title: 'id', sortable: true, visible: false,
                },
                {
                  field: 'body', title: 'body', sortable: true, formatter: 'jsonColFormatter'
                },
              ],
              data: log,
              sortName: 'createdAt', sortOrder: 'desc'
            });
          }, true);
        }

        function init() {
          showSpinner();

          Database.authenticate(() => {
            // temp
            // updateLocalsTable();
            hideSpinner();
          });
        }

        document.addEventListener('bikedeboa.login', function(e) {
          if (BDB.User.isAdmin) {
            // Force table refresh
            $('#localsTable').bootstrapTable('destroy');
            updateLocalsTable();

            Database.getAllTags();

            $('.restricted-access').removeClass('restricted-access');
          }
        });

        document.addEventListener('bikedeboa.logout', function(e) {
          document.location.reload();
        });

        $('#kmlFileInput').on('change', () => {
            var file = document.getElementById("kmlFileInput").files[0];
            if (file) {
              var reader = new FileReader();
              reader.readAsText(file, "UTF-8");
              reader.onload = function (evt) {
                const txt = evt.target.result
                const contentContainer = document.getElementById('fileContents');

                parser = new DOMParser();
                window.xmlDoc = parser.parseFromString(txt, "text/xml");

                console.log(xmlDoc);

                let data = [];
                let tags = [...xmlDoc.getElementsByTagName("Placemark")];
                tags.forEach(p => {
                  let newPlace = {};

                  const children = [...p.children];
                  children.forEach(c => {
                    switch (c.tagName) {
                      case 'name':
                        newPlace.text = c.innerHTML;
                        break;
                      case 'description':
                        newPlace.description = c.innerHTML;
                        break;
                      case 'styleUrl':
                        break;
                      case 'ExtendedData':
                        if (c.children && c.children[0]) {
                          newPlace.photo = c.children[0].children[0].innerHTML;
                          break;
                        }
                      case 'Point':
                        if (c.children && c.children[0]) {
                          // lat and lng are inverted on purporse
                          const [lng, lat] = c.children[0].innerHTML.split(',');
                          newPlace.lat = lat;
                          newPlace.lng = lng;
                        }
                        break;
                      default:
                        // Any other tag that we haven't identified yet
                        newPlace[c.tagName] = c.innerHTML;
                    }

                  });

                  data.push(newPlace);

                })


                // @todo move this to global
                let structureTypes = [];
                for (let i = 0; i < STRUCTURE_NAMES.length; i++) {
                  structureTypes.push({ value: STRUCTURE_CODES[i], text: STRUCTURE_NAMES[i] });
                }

                $('#importador table').bootstrapTable({
                  columns: [
                    {
                      field: 'text', title: 'Nome', sortable: true, class: 'col-title', editable: !!BDB.User.isAdmin
                    },
                    {
                      field: 'address', title: 'Endereço', sortable: true, class: 'col-address', editable: !!BDB.User.isAdmin, 'editable-type': 'textarea'
                    },
                    {
                      field: 'lat', title: 'lat', sortable: true, visible: false,
                    },
                    {
                      field: 'lng', title: 'lng', sortable: true, visible: false,
                    },
                    {
                      field: 'isPublic', title: 'Público?', sortable: true, editable: !!BDB.User.isAdmin, 'editable-type': 'select', 'editable-source': "[{'value': '1', 'text': 'Publico'}, {'value': '0', 'text': 'Exclusivo'} ]",
                    },
                    {
                      field: 'isCovered', title: 'Coberto?', sortable: true, editable: !!BDB.User.isAdmin, 'editable-type': 'select', 'editable-source': "[{'value': '1', 'text': 'Coberto'}, {'value': '0', 'text': 'Não coberto'} ]",
                    },
                    {
                      field: 'structureType', title: 'Tipo', sortable: true, editable: !!BDB.User.isAdmin, 'editable-type': 'select', 'editable-source': JSON.stringify(structureTypes).replace(/\"/g, '\'')
                    },
                    {
                      field: 'description', title: 'Descrição', sortable: true, class: 'col-description', editable: !!BDB.User.isAdmin, 'editable-type': 'textarea', visible: false
                    },
                    {
                      field: 'photo', title: 'Foto', sortable: true, visible: !!BDB.User.isAdmin
                    }
                  ],
                  data: data,
                  sortName: 'text'
                });
              }

              reader.onerror = function (evt) {
                document.getElementById("fileContents").innerHTML = "error reading file";
              }
            }

          });



        /////////////////////
        // Initializations //
        /////////////////////

        Database = BDB.Database; 

        // Admin-only Globals
        let users;
        let log;
        let revisions;
        let reviews;
        let ga = function() {};


        $.fn.editable.defaults.toggle = 'dblclick';


        init();

        //
        // Triggers
        //

        $('a[data-toggle="tab"]').on('shown.bs.tab', e => {
          const tabName = e.target.getAttribute('aria-controls');
          switch (tabName) {
          case 'revisions':
            updateRevisionTable();
            break;
          case 'logs':
            updateLogTable();
            break;
          case 'users':
            updateUsersTable();
            break;
          case 'reviews':
            updateReviewsTable();
            break;
          }
        });

        $('body').on('click', 'tbody tr td', e => {
          if (e.target == e.currentTarget) {
            console.log('details');
            $(e.currentTarget).siblings().find('.detail-icon').trigger('click');
          }
        });

        function updateUser(field, row, oldValue, $el) {
          const userId = row.id;
          let dataToUpdate = {};
          dataToUpdate[field] = row[field];

          // Send the updated data through the API
          if (dataToUpdate) {
            console.log('updating:', dataToUpdate);
            BDB.Database.customAPICall('put', `user/${userId}`, dataToUpdate);
          }
        }

        function updateLocal(field, row, oldValue, $el) {
          const localId = row.id;
          let dataToUpdate = {};

          if (field === 'isPublic' || 'isCovered') {
            row[field] = row[field]==='1' ? true : false;
          } else if (field === 'photo') {
            row['photoUrl'] = row[field];
            field = 'photoUrl';
          }

          dataToUpdate[field] = row[field];

          // Send the updated data through the API
          if (dataToUpdate) {
            console.log('updating:', dataToUpdate);
            BDB.Database.customAPICall('put', `local/${localId}`, dataToUpdate);
          }
        }

        $('body').on('editable-save.bs.table', (e, field, row, oldValue, $el) => {
          if (row.username) {
            updateUser(field, row, oldValue, $el);
          } else {
            updateLocal(field, row, oldValue, $el);
          }

        });


      </script>


      <!-- External -->

      <!-- Hotjar -->
      <script>  
        if ('<BDB_ENV>' === 'prod') {
          (function(h,o,t,j,a,r){
              h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
              h._hjSettings={hjid:476334,hjsv:5};
              a=o.getElementsByTagName('head')[0];
              r=o.createElement('script');r.async=1;
              r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
              a.appendChild(r);
          })(window,document,'//static.hotjar.com/c/hotjar-','.js?sv=');
        }
      </script>

    </body>

</html>
